
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthed() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.role;
    }

    function isRole(role) {
      return isAuthed() && getUserRole() == role;
    }
    
    function isAnyRole(roles) {
      return isAuthed() && getUserRole() in roles;
    }
    
    // Collection-level access rules
    
    // Only admins can write roles, but any authenticated user can read their OWN role.
    match /roles_admin/{userId} {
      allow read: if isAuthed() && request.auth.uid == userId;
      allow write: if isRole('Superuser'); // Protect role assignments
    }
    
    // Only authenticated users can see other users' basic info
    match /users/{userId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && request.auth.uid == userId; // Users can update their own info
    }
    
    // Jobs can be read by anyone authenticated, written by leads/supervisors
    match /jobs/{jobId} {
        allow read: if isAuthed();
        allow write: if isAnyRole(['Superuser', 'B1 Supervisor', 'B2 Supervisor', 'Tapehead Lead']);
    }

    // Tapeheads: Operators can write, supervisors can read/review.
    match /tapeheads-submissions/{reportId} {
      allow read: if isAnyRole(['Superuser', 'B2 Supervisor', 'Tapehead Lead']);
      allow write: if isAnyRole(['Superuser', 'Tapehead Operator', 'Tapehead Lead']);
    }
    
    // Gantry: Leads/Supervisors only
    match /gantry-reports/{reportId} {
      allow read, write: if isAnyRole(['Superuser', 'B1 Supervisor', 'Gantry Lead']);
    }
    
    // Films: Leads/Supervisors only
    match /films/{reportId} {
       allow read, write: if isAnyRole(['Superuser', 'B1 Supervisor', 'Films Lead']);
    }

    // Graphics: Leads/Supervisors only
    match /graphics-tasks/{taskId} {
      allow read, write: if isAnyRole(['Superuser', 'B1 Supervisor', 'Graphics Lead']);
    }
    
    // Inspections: QC, Management, and Supervisors
    match /inspections/{inspectionId} {
      allow read, write: if isAnyRole(['Superuser', 'Quality Manager', 'Management', 'B1 Supervisor', 'B2 Supervisor']);
    }
    
    // Pregger: Leads/Supervisors only
    match /pregger-reports/{reportId} {
        allow read, write: if isAnyRole(['Superuser', 'B2 Supervisor', 'Pregger Lead']);
    }
  }
}
